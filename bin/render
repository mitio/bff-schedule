#!/usr/bin/env ruby
# encoding: utf-8

require 'rubygems'
require 'bundler/setup'
require 'prawn'
require_relative '../helpers'
require_relative '../schedule'

if ARGV.size < 2
  puts "Usage: #{__FILE__} path-to-schedule.csv path-to-output.pdf"
  exit 1
end

input_file, output_file = ARGV
schedule = Schedule.new input_file
root_path = File.expand_path('../..', __FILE__)

# Settings
main_font          = "#{root_path}/fonts/DejaVuSans.ttf"
hour_height        = 37
hour_column_width  = 40
event_column_width = 150
min_event_height   = 25
column_spacing     = 10
events_columns = {
  -> event { event.location == 'Тържествена зала' } => {
    background_color: 'EFACB2',
    text_color: 'B71C16',
  },
  -> event { event.location == 'Заседателна зала' } => {
    background_color: 'C0FCC3',
    text_color: '4DB818',
  },
}
hour_labels = {
  '10:30' => 1.5,
  '12:00' => 1.5,
  '13:30' => 3.5,
  '17:00' => 3.0,
  '20:00' => 2.5,
  '22:30' => 1.5,
  '00:00' => 0.5,
}

Prawn::Document.generate(output_file, page_size: 'A5', page_layout: :portrait) do
  font main_font, size: 10

  # First page
  font main_font, size: 20, style: :bold do
    text 'Банско филм фест', align: :center
    text '2012', align: :center
  end

  schedule.sort_by(&:starts_at).group_by(&:date).each do |date, day_events|
    start_new_page margin: 10
    text "#{weekday_for date}, #{date.day}-и"

    move_down 10
    columns_top = cursor

    # Hours column
    top_offset = columns_top
    hour_labels.each do |hour_label, duration|
      hour_box_height = duration * hour_height
      bounding_box([0, top_offset], width: hour_column_width, height: hour_box_height) do
        text hour_label
      end
      top_offset -= hour_box_height
    end

    # Events columns
    left_offset = hour_column_width + column_spacing
    events_columns.each do |event_filter, properties|
      top_offset = columns_top

      # Group events if needed so that no event box
      # will be shorter than min_event_height
      combined_events = []
      last_combined_event = []
      day_events.select(&event_filter).each do |event|
        if event.coffee_break?
          combined_events << last_combined_event if last_combined_event.any?
          last_combined_event = []
          combined_events << [event]
        else
          last_combined_event << event
          combined_events_height = last_combined_event.map { |e| e.duration / 3600.0 * hour_height }.reduce(:+)

          if combined_events_height >= min_event_height
            combined_events << last_combined_event
            last_combined_event = []
          end
        end
      end
      combined_events << last_combined_event if last_combined_event.any?

      combined_events.each do |events|
        event_box_height = events.map { |event| event.duration / 3600.0 * hour_height }.reduce(:+)
        coffee_break = events.all?(&:coffee_break?)

        unless coffee_break
          # Draw boxes
          fill_color properties[:background_color]
          stroke_color properties[:text_color]
          self.line_width = 2
          stroke_rounded_rectangle [left_offset, top_offset], event_column_width, event_box_height, 10
          fill_rounded_rectangle [left_offset, top_offset], event_column_width, event_box_height, 10
          fill_color properties[:text_color]
        end

        bounding_box([left_offset, top_offset], width: event_column_width, height: event_box_height) do
          text events.map(&:name).join(', '), size: 7 unless coffee_break
        end
        top_offset -= event_box_height
      end
      left_offset += event_column_width + column_spacing
    end
  end

  # Sponsors
  start_new_page
  image "#{root_path}/images/sponsors.png", fit: [bounds.width - 20, bounds.height - 20],
                                            position: :center,
                                            vposition: :center
end

puts "Generated #{output_file}"
